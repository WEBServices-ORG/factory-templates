name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate-template:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install mise
        run: brew install mise

      - name: Ensure template exists
        run: |
          test -d swiftui-macos-app || (echo "Missing swiftui-macos-app template folder" && exit 1)

      - name: Install toolchain (from template)
        run: |
          cd swiftui-macos-app
          mise trust || true
          mise install

      - name: Materialize template tokens for CI
        run: |
          cd swiftui-macos-app
          APP="TemplateCIApp"
          BUNDLE_PREFIX="com.webservicesorg.templateci"
          DEPLOYMENT_TARGET="14.0"
          perl -pi -e 's/\{\{PRODUCT_NAME\}\}/'"$APP"'/g; s/\{\{BUNDLE_PREFIX\}\}/'"$BUNDLE_PREFIX"'/g; s/\{\{DEPLOYMENT_TARGET\}\}/'"$DEPLOYMENT_TARGET"'/g' Project.swift Tests/AppTests/* factory/git-hooks/pre-commit 2>/dev/null || true

      - name: Generate Xcode project (headless)
        run: |
          cd swiftui-macos-app
          mise exec tuist -- tuist generate

      - name: Run tests (headless)
        run: |
          cd swiftui-macos-app
          APP="TemplateCIApp"
          mise exec tuist -- tuist generate
          xcodebuild test -scheme "$APP" -destination "platform=macOS" -quiet
